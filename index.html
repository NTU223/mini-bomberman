<html>
  <head>
    <style>canvas{ border: 1px solid; }</style>
  </head>
  <body style="background-color: black; overflow: hidden;">
    <canvas id="screen" width="1024" height="1024"></canvas>
  </body>
  <script type="text/javascript" src="Bomberman.js"></script>
  <script type="text/javascript" src="CanvasUtils.js"></script>
  <script type="text/javascript" src="Obstacle.js"></script>
  <script type="text/javascript" src="Bomb.js"></script>
  <script>
    var move = [[-1, 0], [0, 1], [1, 0], [0, -1]];
    var rows = 15, cols = 31;
    var size = 24;
    var map = new Array(rows);
    var players = [];
    var bombs = [];

    function draw() {
      drawRectangle(0, 0, rows * size, cols * size, 'rgb(154, 207, 130)');
      for (var i = 0; i < rows; i++)
        for (var j = 0; j < cols; j++)
          if (map[i][j])
            map[i][j].draw();
      
      players.forEach(function(player) {
        player.draw();
      });
    };

    function daemon() {
      while (bombs.length > 0 && bombs[0].explosionTime <= 0) {
        bombs[0].remove();
        bombs.shift();
      }

      bombs.forEach(function(bomb) {
        bomb.count();
      });

      players.forEach(function(player) {
        player.move();
      });

      draw();
    };

    function init() {
      for (var i = 0; i < rows; i++)
        map[i] = new Array(cols);
      for (var i = 0; i < rows; i++)
        for (var j = 0; j < cols; j++) {
          if (i % 2 == 1 && j % 2 == 1)
            map[i][j] = new Obstacle(i, j);
          else
            map[i][j] = undefined;
        }
      players.push(new Bomberman(0, 0, [38, 39, 40, 37, 32], "white"));
      players.push(new Bomberman(0, 1, [87, 68, 83, 65, undefined], "blue"));
      setInterval(daemon, 17);
    };

    window.onload = init;

    function doKeydown(e) {
      players.forEach(function(player) {
        for (var j = 0; j < 4; j++)
          if (e.keyCode == player.key[j]){
            player.setDirectionDown(j);
            return false;
          }
        if (e.keyCode == player.key[4])
          player.setBomb();
      });
    }
    function doKeyup(e) {
      players.forEach(function(player) {
        for (var j = 0; j < 4; j++)
          if (e.keyCode == player.key[j]){
            player.setDirectionUp(j);
            return false;
          }
      });
    }
    document.onkeydown = doKeydown;
    document.onkeyup = doKeyup;
  </script>
</html>